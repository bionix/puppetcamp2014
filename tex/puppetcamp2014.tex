%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
\documentclass{beamer}
\usepackage[utf8]{inputenc}
\usepackage{graphics}
\usepackage{listings}
\usepackage{caption}

\captionsetup{font=scriptsize,labelfont=scriptsize}

\usetheme{default}
\usecolortheme{rose}

\DeclareGraphicsRule{.pdftex}{pdf}{.pdftex}{}

% \lstdefinelanguage{cfengine}
%   {morekeywords={import,classes,control,admit,copy,editfiles,processes,shellcommands},
%    sensitive=false,
%    morecommment[l]{//},
%   }

\newcommand\Fontvi{\fontsize{6}{7.2}\selectfont}

\lstset{
basicstyle=\tiny,
stringstyle=\tiny,
numbers=left,
numberstyle=\tiny,
stepnumber=2,
frame=single,
%language=cfengine,
captionpos=b
}

\title{Continuously deliver your puppet code with jenkins, r10k and git\\}
\author{Toni Schmidbauer}

\begin{document}

\begin{frame}
  \center\includegraphics[height=2.5cm,width=2cm]{../pics/puppet.png}
  \titlepage
\end{frame}

\begin{frame}
  \frametitle{whoami}
  \begin{itemize}
  \item SysAdmin@s-itsolutions.at
  \item toni@stderr.at
  \item \url{http://stderr.at}
  \item \url{http://github.com/tosmi}
  \item stderr@jabber.org
  \end{itemize}
\end{frame}
\begin{frame}

  \frametitle{Agenda}

  \begin{itemize}
  \item A short story about configuration managment
  \item What is continous delivery
  \item How do we develop our Puppet code
  \item And what about deploying the code?
  \item Jenkins, GIT and r10k!
  \item Where do we go from here
  \end{itemize}

\end{frame}

\begin{frame}
  \frametitle{A short story about configuration management (CM)}

  \begin{itemize}
  \item<1-> We manage a very diverse environment of UNIX/Linux Systems (Solaris 10/11, AIX, RHEL 5/6/7)
  \item<2-> Before CM we had \textbf{strict} standards on how to manage these systems
  \item<3-> The problem: \\count(teammembers) == count(standards)
  \item<4-> So configuration management is the solution to all our problems
  \end{itemize}

\end{frame}

\begin{frame}
  \frametitle{The solution to all our problems}
  \pause
  \begin{itemize}
  \item Broke our systems
  \end{itemize}
\end{frame}

\begin{frame}
  \center{\huge{WHY????}}
\end{frame}

\begin{frame}
  \frametitle{Problems with our old CM system}

  \begin{itemize}
  \item Systems installed without CM are hard to bring under CM control
  \item Every system is a special case
  \item In the beginning every problem was a CM problem
  \item CFEngine 2 based, no unit tests
  \item Deployment in stages, but we always had to cross our fingers
  \item Deployment via manual tagging and checkout, so mistakes happened
  \item We fixed the same mistakes more than once
  \end{itemize}
\end{frame}

\begin{frame}
  \center{\huge{So whats our solution?}}

  or: why should i care?
\end{frame}

\begin{frame}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=7.5cm,width=6cm]{../pics/cd_book}
    \label{fig:stack}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Continuous delivery}
  \begin{itemize}
  \item<1-> is a pattern for getting software from development to release
  \item<2-> this pattern is called \textbf{the deployment pipeline}
  \end{itemize}
  \footnote{Continuous Delivery: Jez Humble, David Farley}
\end{frame}

\begin{frame}
  \frametitle{The deployment pipeline}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=1cm,width=10cm]{../pics/deployment_pipline}
    \label{fig:stack}
  \end{figure}
  \pause \tiny but the automated acceptance tests are currently missing in our
  setup, we will fix this with beaker (thanks puppetlabs)
\end{frame}

\begin{frame}
  \frametitle{Jenkins}

  \begin{itemize}
  \item Jenkins is an Open Source continuous integration server
  \item It's purpose is to execute and monitor jobs
  \item Jobs are shell scripts or any other thing that's executable
    and returns 0 on success
  \item You can link jobs together, thats our pipeline
  \item Many plugins available to extend Jenkins (e.g. git, build-pipeline, monitor)
  \end{itemize}

\end{frame}


\begin{frame}
  \frametitle{Jenkins II}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=6cm,width=11cm]{../pics/jenkins_pipeline}
    \label{fig:stack}
  \end{figure}
\end{frame}


\begin{frame}
  \frametitle{Monitoring with Jenkins}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=6cm,width=11cm]{../pics/jenkins_monitor}
    \label{fig:stack}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{a word on testing}

  \begin{itemize}
  \item you must have unit tests for your puppet code: \textbf{rspec-puppet}
  \item you need to test everything to get most out of the build
    pipeline
  \item we test
    \begin{itemize}
    \item interal puppet modules
    \item hiera data
    \item puppet configuration
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{rspec-puppet}

  \begin{itemize}
  \item Ruby RSpec (unit tests) for puppet
  \item Every interal module must have rspec tests
  \end{itemize}

  \begin{lstlisting}
require 'spec_helper'
describe 'linuxwochen2014' do
  let :facts { { :osfamily => 'RedHat' } }

  context 'ensure is set to absent' do
    let :params { { :ensure => 'absent'} }

    it do
      should contain_user('toni').with({
                                         'ensure' => 'absent',
                                         'uid'    => '4711',
                                         'gid'    => '100',
                                      })
    end

    it { should contain_package('emacs-nox').with_ensure('installed') }
    it { should contain_package('vim-enhanced').with_ensure('absent') }
    it { should contain_package('emacs-nox).that_comes_before('Package[vim-enhanced]') }
  end
end
  \end{lstlisting}

\end{frame}


\begin{frame}
  \frametitle{GIT}

  \begin{itemize}
  \item One central repository managed with gitolite (access control for git)
  \item 3 main branches
    \begin{itemize}
    \item development
    \item testing
    \item production
    \end{itemize}
  \item feature branches for new site local modules
  \item hiera data is in the same repository
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{GIT workflow}
  \begin{figure}
    \centering
      \includegraphics[height=6cm,width=11cm]{../pics/puppet_deployment2}
    \label{fig:stack}
  \end{figure}

\end{frame}

\begin{frame}
  \frametitle{r10k}

  \begin{itemize}
  \item a tool to deploy puppet environments and modules
  \item every git branch gets deploy to a puppet environment
  \item in the current version (1.3.2) dependencies have to be managed
    manually
  \end{itemize}

\end{frame}

\begin{frame}
  \frametitle{GIT repository layout for r10k}

  \begin{itemize}
  \item modules/: where r10k stores external (forge, github) modules
  \item site/: site local modules, that we do not want to share
  \item hiera/: our hiera yaml files
  \item Puppetfile: config file for r10k that specifies which modules we need
  \end{itemize}
\end{frame}

\begin{frame}
  \center{\huge DEMO}
\end{frame}

\begin{frame}
  \center{\huge Thanks for you attention!}
\end{frame}


\end{document}


%
% old stuff
%

\begin{frame}
  \frametitle{Puppet run}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=6cm,width=11cm]{../pics/puppet_overview}
    \label{fig:stack}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Was ist Foreman?}
  \begin{figure}[ht]
    \centering
    \framebox{
      \includegraphics[height=7.5cm,width=10.3cm]{../pics/foreman_dashboard.png}
    }
    \label{fig:stack}
  \end{figure}
\end{frame}



\begin{frame}
  \begin{itemize}
  \item Wie soll eine Entwicklungsumgebung aussehen?
  \item Wie testen wir den Puppet Code?
  \item Wie verwalten wir unseren Puppet Code?
  \item Wie soll unsere Puppet Umgebung aussehen?
  \item Wie erfolgt das Deployment des Codes?
  \item Wie verwalten wir Module von PuppetForge?
  \end{itemize}
\end{frame}

\begin{frame}
  \center{\huge{Wie soll eine Entwicklungsumgebung aussehen?}}
\end{frame}

\begin{frame}
  \frametitle{Vagrant}

  \begin{itemize}
  \item \url{http://vagrantup.com}
  \item Ermöglicht virtuelle Entwicklungsumgebungen
  \item Vagrant Box ist ein vorkonfiguriertes Image
  \item Default VirtualBox andere Provider via Plugins (VMWare, KVM)
  \end{itemize}
\end{frame}

\begin{frame}
  \center{\huge{Demo}}
\end{frame}

\begin{frame}
  \center{\huge{Wie testen wir den Puppet Code?}}
\end{frame}

\begin{frame}[fragile]
  \frametitle{rspec-puppet}

  \begin{itemize}
  \item Ruby RSpec Tests für Puppet
  \item Jedes Module muss RSpec Tests mitbringen
  \end{itemize}

  \begin{lstlisting}
require 'spec_helper'
describe 'linuxwochen2014' do
  let :facts { { :osfamily => 'RedHat' } }

  context 'ensure is set to absent' do
    let :params { { :ensure => 'absent'} }

    it do
      should contain_user('toni').with({
                                         'ensure' => 'absent',
                                         'uid'    => '4711',
                                         'gid'    => '100',
                                      })
    end

    it { should contain_package('emacs-nox').with_ensure('installed') }
    it { should contain_package('vim-enhanced').with_ensure('absent') }
    it { should contain_package('emacs-nox).that_comes_before('Package[vim-enhanced]') }
  end
end
  \end{lstlisting}

\end{frame}

\begin{frame}
  \center{\huge{Demo}}
\end{frame}

\begin{frame}
  \center{\huge{Wie verwalten wir unseren Puppet Code?}}
\end{frame}

\begin{frame}
  \frametitle{GIT}

  \begin{itemize}
  \item Ein zentrales GIT Repository
  \item 3 Hauptbranches
    \begin{itemize}
    \item Master
    \item Testing
    \item Production
    \end{itemize}
  \item Feature Branches für neue Module
  \item Berechtigungssystem mit Gitolite
  \end{itemize}
\end{frame}

% \begin{frame}
%   \center{\huge{Demo}}
% \end{frame}

\begin{frame}
  \center{\huge{Wie soll unsere Puppet Umgebung aussehen?}}
  \center{\huge{Wie erfolgt das Deployment des Codes?}}
\end{frame}

\begin{frame}
  \frametitle{Umgebungen}

    \begin{itemize}
    \item Development (Master)
      \begin{itemize}
      \item Test auf 7 Entwicklungsserver
      \item Push auf Remote Master Branch löst Deployment aus
      \item RedHat 5,6 / Solaris {sparc,i386} {10,11} / AIX
      \end{itemize}
    \item Testing
      \begin{itemize}
      \item ca. 30 ``Produktions'' Server
      \item Annotated Tags werden automatisch deployed (test\_*)
      \end{itemize}
    \item Production
      \begin{itemize}
      \item ca 1000 Hosts
      \item Annotated Tags werden automatisch deployed (prod\_*)
      \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Puppet Umgebung und Deployment}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=5.5cm,width=11cm]{../pics/puppet_deployment2}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Deployment}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=5cm,width=11cm]{../pics/jenkins_pipeline}
    \label{fig:stack}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Monitoring}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=6cm,width=11cm]{../pics/jenkins_monitor.png}
    \label{fig:stack}
  \end{figure}
\end{frame}


\begin{frame}
  \center{\huge{Wie verwalten wir Module von PuppetForge?}}
\end{frame}

\begin{frame}
  \frametitle{Puppetforge Module}

  \begin{itemize}
  \item Eigenes GIT Repository (puppetforge.git)
  \item Download der Module in der Enwicklungsumgebung via \\ \texttt{puppet module install ...}
  \item Staging GIT pull (bäh!)
  \item Dies ändert sich allerdings (dazu später)
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{itemize}
  \item Wie soll eine Entwicklungsumgebung aussehen? \emph{\color{green}DONE}
  \item Wie testen wir den Puppet Code? \emph{\color{green}DONE}
  \item Wie verwalten wir unseren Puppet Code? \emph{\color{green}DONE}
  \item Wie soll unsere Puppet Umgebung aussehen?  \emph{\color{green}DONE}
  \item Wie erfolgt das Deployment des Codes? \emph{\color{green}DONE}
  \item Wie verwalten wir Module von PuppetForge? \emph{\color{green}DONE}
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{figure}[ht]
    \centering
      \includegraphics[height=6cm,width=10cm]{../pics/puppy.png}
    \label{fig:stack}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Probleme, Probleme, Probleme...}

  \begin{itemize}
  \item Ein GIT Repo funktioniert nicht bei Änderungen von Upstream Modulen
  \item Andere Abteilungen sollen ihre Module unabhänging testen
  \item Unittests sagen noch nichts aus wie sich der Code am Live-System verhält
  \item Wir sollten eigentlich das Zusammenspiel aller Module testen (Forge und eigene)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Was haben wir geplant?}

  \begin{itemize}
  \item r10k für Deployment (\url{https://github.com/adrienthebo/r10k})
  \item Ein Repository pro Module
  \item Nur interne Module bleiben im Hauptrepo
  \item Acceptance Tests mit Beaker
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Links und Bücher}
\tiny
  \begin{itemize}
  \item \url{http://github.com/tosmi/linuxwochen2014}
  \item \url{http://github.com/tosmi/puppet-devel}
  \item Puppet Learning VM: \url{http://puppetlabs.com/download-learning-vm}
  \item Foreman: \url{http://theforeman.org}
  \item Vagrant: \url{http://vagrantup.com}
  \item rspec-puppet: \url{http://rspec-puppet.com/}
  \item puppet-lint: \url{http://puppet-lint.com/}
  \item Gitolite: \url {http://gitolite.com/}
  \item r10k: \url{https://github.com/adrienthebo/r10k}
  \item Roles and Profiles: \url{http://www.craigdunn.org/2012/05/239/}
  \item Dynamische Puppet Umgebungen: \url{http://puppetlabs.com/blog/git-workflow-and-puppet-environments}
  \item puppet-sync: \url{https://github.com/pdxcat/puppet-sync}
  \item \texttt{Instant Puppet 3 Starter}
  \item \texttt{Pro Puppet 2nd}
  \item \texttt{The RSpec Book}
  \item \texttt{Pulling Strings with Puppet}
  \item \texttt{Continuous Delivery}
  \end{itemize}
\end{frame}

\begin{frame}
  \huge{Danke für die Aufmerksamkeit}
\end{frame}
\end{document}
